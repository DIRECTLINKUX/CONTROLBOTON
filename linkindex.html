<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Apertura</title>
<style>
  body {
    font-family: Arial; 
    background: #f0f0f0; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100vh; 
    margin: 0;
  }
  .cuadro {
    background: white;
    padding: 40px;
    border-radius: 10px;
    box-shadow: 0 0 20px rgba(0,0,0,0.3);
    text-align: center;
    max-width: 500px;
    width: 90%;
    font-size: 2em; /* Agranda todo el texto y botones */
  }
  h2 { margin-bottom: 10px; }
  p { margin: 15px 0; }
  button {
    font-size: 1em; 
    padding: 15px 35px; 
    margin: 10px; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer;
  }
  #abrir { background: #28a745; color: white; }
  #apagar { background: #dc3545; color: white; }
  #mensaje { color: red; margin-top: 20px; }

  /* Botones deshabilitados en gris */
  button:disabled {
    background: #aaa !important;
    color: #666 !important;
    cursor: not-allowed;
  }

  @media (max-width: 600px) {
    .cuadro { font-size: 2em; }
    button { padding: 20px 40px; font-size: 1.2em; }
  }
</style>
</head>
<body>

<div class="cuadro">
  <h2>Control de Apertura</h2>
  <p id="apartamento"></p>
  <p>Inicio: <span id="fechaInicio"></span> <span id="horaInicio"></span></p>
  <p>Fin: <span id="fechaFin"></span> <span id="horaFin"></span></p>
  
  <button id="abrir">Abrir</button>
  <button id="apagar">Cerrar</button>

  <p id="mensaje"></p>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const f1 = params.get('f1'); 
  const h1 = params.get('h1'); 
  const f2 = params.get('f2'); 
  const h2 = params.get('h2'); 
  const a  = Math.min(Math.max(parseInt(params.get('a')),1),10) || 1;

  const luces = {
    1: {encender: 'http://192.168.1.51/encender', apagar: 'http://192.168.1.51/apagar'},
    2: {encender: 'http://192.168.1.52/encender', apagar: 'http://192.168.1.52/apagar'},
    3: {encender: 'http://192.168.1.53/encender', apagar: 'http://192.168.1.53/apagar'},
    4: {encender: 'http://192.168.1.54/encender', apagar: 'http://192.168.1.54/apagar'},
    5: {encender: 'http://192.168.1.55/encender', apagar: 'http://192.168.1.55/apagar'},
    6: {encender: 'http://192.168.1.56/encender', apagar: 'http://192.168.1.56/apagar'},
    7: {encender: 'http://192.168.1.57/encender', apagar: 'http://192.168.1.57/apagar'},
    8: {encender: 'http://192.168.1.58/encender', apagar: 'http://192.168.1.58/apagar'},
    9: {encender: 'http://192.168.1.59/encender', apagar: 'http://192.168.1.59/apagar'},
    10:{encender: 'http://192.168.1.60/encender', apagar: 'http://192.168.1.60/apagar'}
  };

  function formatearFechaHora(f, h){
    return { 
      fecha: f.slice(0,4)+'-'+f.slice(4,6)+'-'+f.slice(6,8),
      hora: h.slice(0,2)+':'+h.slice(2,4)
    };
  }

  const inicio = formatearFechaHora(f1,h1);
  const fin = formatearFechaHora(f2,h2);

  // Mostrar apartamento
  document.getElementById('apartamento').textContent = `Apartamento ${a}`;
  document.getElementById('fechaInicio').textContent = inicio.fecha;
  document.getElementById('horaInicio').textContent = inicio.hora;
  document.getElementById('fechaFin').textContent = fin.fecha;
  document.getElementById('horaFin').textContent = fin.hora;

  const btnAbrir = document.getElementById('abrir');
  const btnApagar = document.getElementById('apagar');
  const mensaje = document.getElementById('mensaje');

  function validarAcceso(){
    const ahora = new Date();
    const fIni = new Date(`${inicio.fecha}T${inicio.hora}:00`);
    const fFin = new Date(`${fin.fecha}T${fin.hora}:00`);

    if(ahora >= fIni && ahora <= fFin){
      btnAbrir.disabled = false;
      btnApagar.disabled = false;
      mensaje.textContent = '';
    } else {
      btnAbrir.disabled = true;
      btnApagar.disabled = true;
      mensaje.textContent = 'Fuera de fechas u horario';
    }
  }

  validarAcceso();
  setInterval(validarAcceso, 60000);

  btnAbrir.onclick = () => fetch(luces[a].encender).catch(()=>alert('No se pudo enviar señal'));
  btnApagar.onclick = () => fetch(luces[a].apagar).catch(()=>alert('No se pudo enviar señal'));
</script>

</body>
</html>
