<!DOCTYPE html>
<html lang="es">

<!-- ================================================= -->
<!-- BLOQUE 1 — CABECERA HTML -->
<!-- ================================================= -->
<head>
<meta charset="UTF-8">
<title>Apertura de 6 Puertas</title>

<style>


/* BLOQUE 2 — ESTILO GENERAL (agregar al final) */

/* Flex para filas etiqueta-valor */
.fila-flex {
    display: flex;
    justify-content: space-between;
    width: 100%;
    max-width: 400px;
    margin: 0 auto 1rem auto;
}

/* Etiqueta a la izquierda */
.fila-flex .label {
    text-align: left;
    font-weight: bold;
}

/* Valor a la derecha */
.fila-flex .valor {
    text-align: right;
}

/* Responsive: en pantallas <500px, apilar verticalmente */
@media(max-width:500px){
    .fila-flex {
        flex-direction: column;
        align-items: flex-start;
    }
    .fila-flex .valor {
        text-align: left;
        margin-top: 0.2rem;
    }
}




/* ================================================= */
/* BLOQUE 3 — PANELES DE PUERTAS */
/* ================================================= */

.panel{
border-radius:15px;
padding:1.5rem;
margin-bottom:2rem;
box-shadow:0 8px 18px rgba(0,0,0,0.25);
}

.panel.portal{
background:#e3f5ea;
border:3px solid #145c2c;
}

.panel.apto{
background:#e8edff;
border:3px solid #1a3f9e;
}

/* ================================================= */
/* BLOQUE 4 — CONTENEDOR BOTONES */
/* ================================================= */

.botones{
display:flex;
justify-content:center;
align-items:center;
gap:6rem;
margin-top:2rem;
flex-wrap:wrap;
}

/* ================================================= */
/* BLOQUE 5 — BOTONES */
/* ================================================= */

button{
width:250px;
padding:1.6rem 0.5rem;
font-size:2rem;
border-radius:15px;
border:none;
cursor:pointer;
font-weight:bold;
transition:all .15s;
color:white;
box-shadow:0 6px 12px rgba(0,0,0,0.4);
}

.btn-abrir{
background:linear-gradient(to bottom,#1f7a3a,#0f4f23);
}

.btn-cerrar{
background:linear-gradient(to bottom,#a32020,#5c0f0f);
}

button:disabled{
background:#050505!important;
color:#222!important;
box-shadow:none;
cursor:not-allowed;
}

/* ================================================= */
/* BLOQUE 6 — MENSAJES */
/* ================================================= */

#mensaje{
font-size:2rem;
margin-top:1rem;
}

.habilitado{
color:#0b7a2a;
font-weight:bold;
}

.denegado{
color:#b30000;
font-weight:bold;
}

/* ================================================= */
/* BLOQUE 7 — RESPONSIVE */
/* ================================================= */

@media(max-width:700px){
button{
width:45%;
font-size:1.7rem;
}
}

</style>
</head>

<!-- ================================================= -->
<!-- BLOQUE 8 — INTERFAZ VISUAL (MODIFICADO) -->
<!-- ================================================= -->
<body>

<div class="cuadro">

<h2 style="text-align:center;">Apertura de Puertas</h2>

<div class="fecha-hora" style="text-align:left; font-size:3rem;">
Apartamento: <span id="apartamento"></span>
</div>

<div class="fecha-hora" style="text-align:left; font-size:3rem;">
Inicio:
<span id="fechaInicio"></span>
<span id="horaInicio"></span>
</div>

<div class="fecha-hora" style="text-align:left; font-size:3rem;">
Fin:
<span id="fechaFin"></span>
<span id="horaFin"></span>
</div>

<!-- ================================================= -->
<!-- BLOQUE 9 — PUERTA PORTAL (MODIFICADO) -->
<!-- ================================================= -->

<div class="panel portal">
<div style="font-size:2.5rem;font-weight:bold;text-align:center;">Puerta Portal</div>

<div class="botones">
<!-- Solo un botón Abrir y un botón Cerrar -->
<button id="abrir" class="btn-abrir">Abrir</button>
<button id="apagar" class="btn-cerrar">Cerrar</button>
</div>
</div>

<!-- ================================================= -->
<!-- BLOQUE 10 — PUERTA APARTAMENTO (MODIFICADO) -->
<!-- ================================================= -->

<div class="panel apto">
<div style="font-size:2.5rem;font-weight:bold;text-align:center;">Puerta Apartamento</div>

<div class="botones">
<!-- Solo un botón Abrir y un botón Cerrar -->
<button id="abrirApto" class="btn-abrir">Abrir</button>
<button id="apagarApto" class="btn-cerrar">Cerrar</button>
</div>
</div>

<p id="mensaje"></p>

</div>

<!-- ================================================= -->
<!-- BLOQUE 11 — SCRIPT PRINCIPAL -->
<!-- ================================================= -->
<script>

/* =============================================== */
/* BLOQUE 12 — LECTURA DE PARÁMETROS URL */
/* =============================================== */

const params=new URLSearchParams(window.location.search);

const f1=params.get('f1');
const h1=params.get('h1');
const f2=params.get('f2');
const h2=params.get('h2');

const a=Math.min(Math.max(parseInt(params.get('a')),1),10)||1;
const p=params.get('p')==='1';
const q=params.get('q')==='1';

/* =============================================== */
/* BLOQUE 13 — REFERENCIAS DOM */
/* =============================================== */

const btnAbrir=document.getElementById('abrir');
const btnApagar=document.getElementById('apagar');
const btnAbrirApto=document.getElementById('abrirApto');
const btnApagarApto=document.getElementById('apagarApto');
const mensaje=document.getElementById('mensaje');

/* =============================================== */
/* BLOQUE 14 — DIRECCIONES PORTAL */
/* =============================================== */

const portalLuces={
1:{encender:'http://192.168.1.51/abrirPortal',apagar:'http://192.168.1.51/cerrarPortal'},
2:{encender:'http://192.168.1.52/abrirPortal',apagar:'http://192.168.1.52/cerrarPortal'},
3:{encender:'http://192.168.1.53/abrirPortal',apagar:'http://192.168.1.53/cerrarPortal'},
4:{encender:'http://192.168.1.54/abrirPortal',apagar:'http://192.168.1.54/cerrarPortal'},
5:{encender:'http://192.168.1.55/abrirPortal',apagar:'http://192.168.1.55/cerrarPortal'},
6:{encender:'http://192.168.1.56/abrirPortal',apagar:'http://192.168.1.56/cerrarPortal'},
7:{encender:'http://192.168.1.57/abrirPortal',apagar:'http://192.168.1.57/cerrarPortal'},
8:{encender:'http://192.168.1.58/abrirPortal',apagar:'http://192.168.1.58/cerrarPortal'},
9:{encender:'http://192.168.1.59/abrirPortal',apagar:'http://192.168.1.59/cerrarPortal'},
10:{encender:'http://192.168.1.60/abrirPortal',apagar:'http://192.168.1.60/cerrarPortal'}
};

/* =============================================== */
/* BLOQUE 15 — DIRECCIONES APARTAMENTO */
/* =============================================== */

const aptoLuces={
1:{encender:'http://192.168.1.51/abrirApto',apagar:'http://192.168.1.51/cerrarApto'},
2:{encender:'http://192.168.1.52/abrirApto',apagar:'http://192.168.1.52/cerrarApto'},
3:{encender:'http://192.168.1.53/abrirApto',apagar:'http://192.168.1.53/cerrarApto'},
4:{encender:'http://192.168.1.54/abrirApto',apagar:'http://192.168.1.54/cerrarApto'},
5:{encender:'http://192.168.1.55/abrirApto',apagar:'http://192.168.1.55/cerrarApto'},
6:{encender:'http://192.168.1.56/abrirApto',apagar:'http://192.168.1.56/cerrarApto'},
7:{encender:'http://192.168.1.57/abrirApto',apagar:'http://192.168.1.57/cerrarApto'},
8:{encender:'http://192.168.1.58/abrirApto',apagar:'http://192.168.1.58/cerrarApto'},
9:{encender:'http://192.168.1.59/abrirApto',apagar:'http://192.168.1.59/cerrarApto'},
10:{encender:'http://192.168.1.60/abrirApto',apagar:'http://192.168.1.60/cerrarApto'}
};

/* =============================================== */
/* BLOQUE 16 — FORMATEO FECHA */
/* =============================================== */

function formatearFechaHora(f,h){
return{
fecha:f.slice(0,4)+'-'+f.slice(4,6)+'-'+f.slice(6,8),
hora:h.slice(0,2)+':'+h.slice(2,4)
};
}

const inicio=formatearFechaHora(f1,h1);
const fin=formatearFechaHora(f2,h2);

apartamento.textContent=a;
fechaInicio.textContent=inicio.fecha;
horaInicio.textContent=inicio.hora;
fechaFin.textContent=fin.fecha;
horaFin.textContent=fin.hora;

/* =============================================== */
/* BLOQUE 17 — VALIDACIÓN HORARIA */
/* =============================================== */

function validarAcceso(){

const ahora=new Date();
const fIni=new Date(`${inicio.fecha}T${inicio.hora}:00`);
const fFin=new Date(`${fin.fecha}T${fin.hora}:00`);

const acceso=(ahora>=fIni&&ahora<=fFin);

btnAbrir.disabled=!(acceso&&p);
btnApagar.disabled=!(acceso&&p);
btnAbrirApto.disabled=!(acceso&&q);
btnApagarApto.disabled=!(acceso&&q);

mensaje.innerHTML=
acceso
?'<span class="habilitado">Acceso habilitado</span>'
:'<span class="denegado">Fuera de horario</span>';
}

validarAcceso();
setInterval(validarAcceso,60000);


/* =============================================== */
/* BLOQUE 18 — ACCIONES BOTONES (APERTURA 3s + bloqueo + mensaje) */
/* =============================================== */

function bloquearTodos(botones, estado) {
    botones.forEach(btn => btn.disabled = estado);
}

const todosBotones = [btnAbrir, btnApagar, btnAbrirApto, btnApagarApto];

function abrirTemporalGlobal(dispositivo) {
    // Bloquear todos los botones
    bloquearTodos(todosBotones, true);

    // Cambiar mensaje a "Puerta abriendo..."
    mensaje.innerHTML = '<span class="habilitado">Puerta abriendo...</span>';

    // Enviar señal de apertura
    fetch(dispositivo.encender);

    // Después de 3 segundos, enviar señal de cierre y reactivar botones
    setTimeout(() => {
        fetch(dispositivo.apagar);

        // Volver a validar acceso y actualizar el mensaje según horario
        validarAcceso();

        // Desbloquear todos los botones
        bloquearTodos(todosBotones, false);
    }, 3000); // 3 segundos
}

/* ===== PORTAL ===== */
btnAbrir.onclick = () => {
    abrirTemporalGlobal(portalLuces[a]);
};

/* ===== APARTAMENTO ===== */
btnAbrirApto.onclick = () => {
    abrirTemporalGlobal(aptoLuces[a]);
};

/* ===== CIERRE MANUAL (opcional) ===== */
btnApagar.onclick = () => {
    fetch(portalLuces[a].apagar);
};

btnApagarApto.onclick = () => {
    fetch(aptoLuces[a].apagar);
};



</script>

</body>
</html>
