<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Control de Apertura</title>
<style>
  body {
    font-family: Arial; 
    background: #f0f0f0; 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    height: 100vh; 
    margin: 0;
  }
  .cuadro {
    background: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 0 15px rgba(0,0,0,0.3);
    text-align: center;
    max-width: 400px;
    width: 90%;
  }
  h2 { margin-bottom: 20px; }
  p { margin: 10px 0; font-size: 18px; }
  button {
    font-size: 18px; 
    padding: 10px 25px; 
    margin: 10px; 
    border: none; 
    border-radius: 5px; 
    cursor: pointer;
  }
  #abrir { background: #28a745; color: white; }
  #apagar { background: #dc3545; color: white; }
  #mensaje { font-size: 18px; color: red; margin-top: 20px; }
</style>
</head>
<body>

<div class="cuadro">
  <h2>Control de Apertura</h2>
  <p>Inicio: <span id="fechaInicio"></span> <span id="horaInicio"></span></p>
  <p>Fin: <span id="fechaFin"></span> <span id="horaFin"></span></p>
  
  <button id="abrir">Abrir</button>
  <button id="apagar">Cerrar</button>

  <p id="mensaje"></p>
</div>

<script>
  const params = new URLSearchParams(window.location.search);
  const f1 = params.get('f1'); 
  const h1 = params.get('h1'); 
  const f2 = params.get('f2'); 
  const h2 = params.get('h2'); 
  const k  = params.get('k');  
  const a  = Math.min(Math.max(parseInt(params.get('a')),1),10) || 1;

  const luces = {
    1: {encender: 'http://192.168.1.51/encender', apagar: 'http://192.168.1.51/apagar'},
    2: {encender: 'http://192.168.1.52/encender', apagar: 'http://192.168.1.52/apagar'},
    3: {encender: 'http://192.168.1.53/encender', apagar: 'http://192.168.1.53/apagar'},
    4: {encender: 'http://192.168.1.54/encender', apagar: 'http://192.168.1.54/apagar'},
    5: {encender: 'http://192.168.1.55/encender', apagar: 'http://192.168.1.55/apagar'},
    6: {encender: 'http://192.168.1.56/encender', apagar: 'http://192.168.1.56/apagar'},
    7: {encender: 'http://192.168.1.57/encender', apagar: 'http://192.168.1.57/apagar'},
    8: {encender: 'http://192.168.1.58/encender', apagar: 'http://192.168.1.58/apagar'},
    9: {encender: 'http://192.168.1.59/encender', apagar: 'http://192.168.1.59/apagar'},
    10:{encender: 'http://192.168.1.60/encender', apagar: 'http://192.168.1.60/apagar'}
  };

  function formatearFechaHora(f, h){
    return { fecha: f.slice(0,4)+'-'+f.slice(4,6)+'-'+f.slice(6,8),
             hora: h.slice(0,2)+':'+h.slice(2,4) };
  }

  const inicio = formatearFechaHora(f1,h1);
  const fin = formatearFechaHora(f2,h2);

  document.getElementById('fechaInicio').textContent = inicio.fecha;
  document.getElementById('horaInicio').textContent = inicio.hora;
  document.getElementById('fechaFin').textContent = fin.fecha;
  document.getElementById('horaFin').textContent = fin.hora;

  const btnAbrir = document.getElementById('abrir');
  const btnApagar = document.getElementById('apagar');
  const mensaje = document.getElementById('mensaje');

  async function generarClave(fi, hi, ff, hf){
    const str = fi+hi+ff+hf;
    const msgUint8 = new TextEncoder().encode(str);
    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2,'0')).join('').slice(0,10);
  }

  async function validarAcceso(){
    const claveGenerada = await generarClave(f1,h1,f2,h2);
    const ahora = new Date();
    const fIni = new Date(`${inicio.fecha}T${inicio.hora}:00`);
    const fFin = new Date(`${fin.fecha}T${fin.hora}:00`);

    if(k !== claveGenerada){
      btnAbrir.disabled = true;
      btnApagar.disabled = true;
      mensaje.textContent = 'Link inválido';
    } else if(ahora < fIni || ahora > fFin){
      btnAbrir.disabled = true;
      btnApagar.disabled = true;
      mensaje.textContent = 'Fuera de fechas u horario';
    } else {
      btnAbrir.disabled = false;
      btnApagar.disabled = false;
      mensaje.textContent = '';
    }
  }

  validarAcceso();
  setInterval(validarAcceso, 60000);

  btnAbrir.onclick = () => fetch(luces[a].encender).catch(()=>alert('No se pudo enviar señal'));
  btnApagar.onclick = () => fetch(luces[a].apagar).catch(()=>alert('No se pudo enviar señal'));
</script>

</body>
</html>